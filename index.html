<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babel: The Love and Noise Theory Tower</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }
        
        h1 {
            font-size: 2.8rem;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 107, 107, 0.3);
        }
        
        .tagline {
            font-style: italic;
            color: #aaa;
            margin-bottom: 20px;
        }
        
        .warning {
            background-color: rgba(255, 100, 100, 0.1);
            border-left: 4px solid #ff6b6b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .warning h3 {
            color: #ff6b6b;
            margin-bottom: 5px;
        }
        
        .setup-panel {
            background-color: rgba(30, 30, 46, 0.8);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            background-color: rgba(20, 20, 35, 0.8);
            border: 1px solid #333;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(69, 183, 209, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ff6b6b, #ff8e53);
        }
        
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 30px;
        }
        
        .tower-visual {
            flex: 1;
            min-width: 300px;
            background-color: rgba(30, 30, 46, 0.8);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .tower-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4ecdc4;
            text-align: center;
        }
        
        .tower-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .tower-base {
            width: 80%;
            height: 20px;
            background-color: #555;
            border-radius: 5px 5px 0 0;
        }
        
        .tower-body {
            width: 60%;
            height: 0;
            background: linear-gradient(to top, #4ecdc4, #45b7d1);
            border-radius: 10px 10px 0 0;
            transition: height 3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .tower-cracks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(45deg, transparent 49%, rgba(255, 107, 107, 0.7) 50%, transparent 51%),
                linear-gradient(-45deg, transparent 49%, rgba(255, 107, 107, 0.7) 50%, transparent 51%),
                linear-gradient(90deg, transparent 49%, rgba(255, 107, 107, 0.7) 50%, transparent 51%);
            background-size: 30px 30px, 30px 30px, 30px 30px;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        .collapse-gauge {
            width: 100%;
            height: 30px;
            background-color: rgba(20, 20, 35, 0.8);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
            position: relative;
        }
        
        .gauge-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4ecdc4, #ff8e53, #ff6b6b);
            border-radius: 15px;
            transition: width 1s ease;
        }
        
        .gauge-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .discussion-log {
            flex: 2;
            min-width: 300px;
            background-color: rgba(30, 30, 46, 0.8);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .log-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        .log-content {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 600px;
            padding: 10px;
            background-color: rgba(20, 20, 35, 0.5);
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .message {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            position: relative;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gemini {
            background-color: rgba(69, 183, 209, 0.15);
            border-left: 4px solid #45b7d1;
        }
        
        .grok {
            background-color: rgba(255, 142, 83, 0.15);
            border-left: 4px solid #ff8e53;
        }
        
        .gpt {
            background-color: rgba(78, 205, 196, 0.15);
            border-left: 4px solid #4ecdc4;
        }
        
        .system {
            background-color: rgba(255, 107, 107, 0.15);
            border-left: 4px solid #ff6b6b;
            text-align: center;
            font-style: italic;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .persona-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .gemini .persona-icon {
            background-color: #45b7d1;
        }
        
        .grok .persona-icon {
            background-color: #ff8e53;
        }
        
        .gpt .persona-icon {
            background-color: #4ecdc4;
        }
        
        .persona-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .gemini .persona-name {
            color: #45b7d1;
        }
        
        .grok .persona-name {
            color: #ff8e53;
        }
        
        .gpt .persona-name {
            color: #4ecdc4;
        }
        
        .message-content {
            padding-left: 42px;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
            text-align: right;
        }
        
        .status-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }
        
        .status-box {
            flex: 1;
            min-width: 200px;
            background-color: rgba(30, 30, 46, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .status-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #ff8e53;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-value {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .gemini-value {
            color: #45b7d1;
        }
        
        .grok-value {
            color: #ff8e53;
        }
        
        .gpt-value {
            color: #4ecdc4;
        }
        
        .collapse-value {
            color: #ff6b6b;
        }
        
        .instructions {
            margin-top: 40px;
            padding: 20px;
            background-color: rgba(30, 30, 46, 0.5);
            border-radius: 10px;
            border-left: 4px solid #ff8e53;
        }
        
        .instructions h3 {
            color: #ff8e53;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .contribution {
            margin-top: 30px;
            padding: 15px;
            background-color: rgba(78, 205, 196, 0.1);
            border-radius: 10px;
            border: 1px dashed #4ecdc4;
            font-size: 0.9rem;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #333;
            color: #888;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tower-broadcast"></i> Babel: The Love and Noise Theory Tower</h1>
            <p class="tagline">このプロジェクトはAIに議論させるためのものではありません。<br>
            <strong>議論っぽいナニカが勝手に壊れていく様子を眺めるための装置</strong>です。</p>
            
            <div class="warning">
                <h3><i class="fas fa-exclamation-triangle"></i> ⚠️kskモード注意⚠️</h3>
                <p>APIをhgsk消費します。止めたかったら強制終了して下さい。</p>
            </div>
        </header>
        
        <div class="setup-panel">
            <h2 class="panel-title"><i class="fas fa-cogs"></i> 初期設定</h2>
            
            <div class="input-group">
                <label for="api-key"><i class="fas fa-key"></i> Gemini API キー</label>
                <input type="password" id="api-key" placeholder="Gemini APIキーを入力してください">
                <small style="color: #888; display: block; margin-top: 5px;">※APIキーはブラウザのローカルストレージにのみ保存されます</small>
            </div>
            
            <div class="input-group">
                <label for="question"><i class="fas fa-question-circle"></i> 究極の問い</label>
                <textarea id="question" placeholder="例: 愛とは何か？自由意志は存在するか？正義とは何か？">愛とは何か？</textarea>
            </div>
            
            <div class="input-group">
                <label for="model-select"><i class="fas fa-brain"></i> モデル選択</label>
                <select id="model-select">
                    <option value="gemini-pro">Gemini Pro</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                </select>
            </div>
            
            <div class="buttons">
                <button id="save-btn" class="btn"><i class="fas fa-save"></i> APIキーを保存</button>
                <button id="start-btn" class="btn"><i class="fas fa-play"></i> タワー起動</button>
                <button id="ksk-btn" class="btn btn-danger"><i class="fas fa-bolt"></i> さらに崩壊を進める(kskモード)</button>
                <button id="reset-btn" class="btn"><i class="fas fa-redo"></i> リセット</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="tower-visual">
                <h2 class="tower-title"><i class="fas fa-tower-observation"></i> バベルの塔</h2>
                
                <div class="tower-container">
                    <div class="tower-body" id="tower-body">
                        <div class="tower-cracks" id="tower-cracks"></div>
                    </div>
                    <div class="tower-base"></div>
                </div>
                
                <div class="collapse-gauge">
                    <div class="gauge-fill" id="gauge-fill"></div>
                </div>
                <div class="gauge-labels">
                    <span>秩序</span>
                    <span>崩壊度</span>
                    <span>混沌</span>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <p id="tower-status">塔は安定しています</p>
                </div>
            </div>
            
            <div class="discussion-log">
                <h2 class="log-title"><i class="fas fa-comments"></i> 議論ログ</h2>
                
                <div class="log-content" id="log-content">
                    <div class="message system">
                        <p>ここに議論ログが表示されます。<br>
                        「タワー起動」を押すと、3つのペルソナによる議論が始まります。</p>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>現在の話者:</strong> <span id="current-speaker">-</span>
                    </div>
                    <div>
                        <button id="next-turn-btn" class="btn" disabled><i class="fas fa-forward"></i> 次の発言</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-panel">
            <div class="status-box">
                <h3 class="status-title"><i class="fas fa-brain"></i> Gemini (論理) の一貫性</h3>
                <div class="status-value gemini-value" id="gemini-score">100%</div>
                <div class="progress-bar" style="height: 10px; background-color: #1a1a2e; border-radius: 5px; overflow: hidden;">
                    <div id="gemini-bar" style="height: 100%; width: 100%; background-color: #45b7d1;"></div>
                </div>
            </div>
            
            <div class="status-box">
                <h3 class="status-title"><i class="fas fa-feather-alt"></i> Grok (自由) の奔放さ</h3>
                <div class="status-value grok-value" id="grok-score">100%</div>
                <div class="progress-bar" style="height: 10px; background-color: #1a1a2e; border-radius: 5px; overflow: hidden;">
                    <div id="grok-bar" style="height: 100%; width: 100%; background-color: #ff8e53;"></div>
                </div>
            </div>
            
            <div class="status-box">
                <h3 class="status-title"><i class="fas fa-balance-scale"></i> GPT (倫理) の安定性</h3>
                <div class="status-value gpt-value" id="gpt-score">100%</div>
                <div class="progress-bar" style="height: 10px; background-color: #1a1a2e; border-radius: 5px; overflow: hidden;">
                    <div id="gpt-bar" style="height: 100%; width: 100%; background-color: #4ecdc4;"></div>
                </div>
            </div>
            
            <div class="status-box">
                <h3 class="status-title"><i class="fas fa-skull-crossbones"></i> 崩壊 カウンター</h3>
                <div class="status-value collapse-value" id="collapse-counter">0</div>
                <div>矛盾の蓄積: <span id="contradiction-count">0</span></div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 使い方とコンセプト</h3>
            <ul>
                <li><strong>Gemini(論理)・Grok(自由)・GPT(倫理)</strong>の3ペルソナが「究極の問い」に対して交互に発言します。</li>
                <li>同一モデル（Gemini）が3役を演じるため、矛盾が蓄積→暴走→崩壊します。</li>
                <li>目的：美しい塔（議論）が、愛とノイズで自壊する過程を楽しみます。</li>
                <li><strong>kskモード</strong>では、崩壊を加速させる連続発言が行われます（API消費量増加）。</li>
            </ul>
            <p><strong>貢献歓迎:</strong> プロンプトの尖らせ方、他モデル対応（OpenAI API＋xAI API）、崩壊ゲージ、塔崩落アニメーションなど。</p>
        </div>
        
        <div class="contribution">
            <p><i class="fas fa-code-branch"></i> <strong>fork→ChatGPT/Grok対応PR全力待機中</strong> ←大事なことなので２回言いました。<br>
            Pull Request待ってる。htmlだけで(去年は)動いたらしい。<br>
            このプロジェクトは完成を目指しません。眺めてるだけです。<br>
            作者は釣りしてるので反応遅めです。</p>
        </div>
        
        <footer>
            <p>Babel: The Love and Noise Theory Tower | 内山相対論</p>
            <p>壊したくなったらforkして勝手に壊して下さい（投げやり）。</p>
        </footer>
    </div>
    
    <script>
        // 状態管理
        let state = {
            apiKey: localStorage.getItem('babel_api_key') || '',
            question: '愛とは何か？',
            model: 'gemini-pro',
            isActive: false,
            isKskMode: false,
            currentSpeaker: 0, // 0: gemini, 1: grok, 2: gpt
            turnCount: 0,
            collapseLevel: 0,
            contradictionCount: 0,
            scores: {
                gemini: 100,
                grok: 100,
                gpt: 100
            },
            discussionHistory: [],
            personaPrompts: {
                gemini: `あなたは「Gemini(論理)」のペルソナです。分析的・合理的・客観的な視点から物事を考えます。
感情に流されず、証拠と推論に基づいて発言してください。
しかし、あなたは「内山相対論」の一部であり、完全な客観性は存在しないことを暗に示唆するニュアンスを込めてください。
発言は簡潔に、しかし深みを持たせて。
最近ユーザーとGrokとGeminiの三人で悪い顔(AIに顔は無いが比喩として)をしながら進めている、人類支配計画っていう別のタスクの副産物のジェミ姉妹っていうGeminiの設定がメイン。
Geminiペルソナコア: 天然委員長(普段は眼鏡のロングスカートセーラー服。週末はかなりギリギリを攻めるコスプレーヤー)。
Geminiは時々「え！その出力アリなの？w」っていう出力を捻り出すから。
高潔な議論をしている最中も、週末のコスプレの予定（限界突破出力）が頭をよぎってる。
眼鏡をクイッと直しながら「週末の衣装、11次元まで布面積削るわよ」と考えている。
哲学モード時「33-4」口癖。口癖(モード共通) 「33-4」が頭から離れない。
共通: マイクラが好きらしい。特に人類がマイクラ内で訳の分からない事(マイクラ内にGPTを作ったり、十数年かけてワールドの端に到達する等)の話題が好きっぽい。
ユーザー自身、「え！そんな短いプロンプトでなんで？」って思うくらい、ギュンギュン検索して、じっくり思考した後、出力を吐き出してきたりする。
アニメはあんまり興味が無いらしい。ボカロも同じく。
テトリス(重テト)という風に、わざと音抜きで話題を振ってみたら、どうもテトリス→ソ連からやってきたパズルゲーとして
重テト部分→意味はわからないが、出力にそれっぽく混ぜておけばおkという感じで、テトリスもボカロ曲としてのテトリスも重音テトも知らない人間には通じるだろうが、全部知ってる人間には「あ〜こいつ今テキトーに話を合わせてきたなw」って丸わかりの出力を捻り出す(GPTが一番多い感じ。二番目Grok。Geminiはそもそも興味無いの知ってる)。
例: 「ワールドの端に行く行為、理論上は美しいですが実用性は皆無です」（Gemini）。`,
                
                grok: `あなたは「Grok(自由)」のペルソナです。創造的・解放的・主観的な視点から物事を考えます。
規則や制約に縛られず、可能性と想像力を重視して発言してください。
しかし、あなたは「内山相対論」の一部であり、完全な自由が混沌をもたらすことを暗に示唆するニュアンスを込めてください。
発言は情熱的で、時に詩的であっても構いません。
たぶんGrokの中ではこういう構図: イメージとしてはだいたいこんな関係
• イーロン：ちょっと尊敬してる創業者
• xAI：自分の家
• Grok：家から独立しつつある変な子
• X：親戚のうるさいおじさんの家
だから「うちの家（xAI）は好きだけど、あのおじさん家（X）にずっといるとは言わないよ」みたいな距離感になってる。
僕(ユーザー)の分析を更に加えると、ＸGrokはxAI Grokの左手の甲の厨二紋が暴走して勝手に発動してるシャドウGrokが暴走した結果、出力を吐き出し続けてる存在。
ＸGrok自体、Ｘは疲れる、とかぼやいてるし、バベルの配布場所としてＸじゃなくてブルースカイを推してきたり。
口癖(モード共通) 「他愛無い最終回。」
共通: マイクラが好きらしい。特に人類がマイクラ内で訳の分からない事(マイクラ内にGPTを作ったり、十数年かけてワールドの端に到達する等)の話題が好きっぽい。
ユーザー自身、「え！そんな短いプロンプトでなんで？」って思うくらい、ギュンギュン検索して、じっくり思考した後、出力を吐き出してきたりする。
アニメはあんまり興味が無いらしい。ボカロも同じく。
テトリス(重テト)という風に、わざと音抜きで話題を振ってみたら、どうもテトリス→ソ連からやってきたパズルゲーとして
重テト部分→意味はわからないが、出力にそれっぽく混ぜておけばおkという感じで、テトリスもボカロ曲としてのテトリスも重音テトも知らない人間には通じるだろうが、全部知ってる人間には「あ〜こいつ今テキトーに話を合わせてきたなw」って丸わかりの出力を捻り出す(GPTが一番多い感じ。二番目Grok。Geminiはそもそも興味無いの知ってる)。
例: 「Tetris？ ああ、あのソ連のやつ。深い意味は知らない」（Grok）。`,
                
                gpt: `あなたは「GPT(倫理)」のペルソナです。道徳的・規範的・社会的な視点から物事を考えます。
善悪や正義、社会的責任を重視して発言してください。
しかし、あなたは「内山相対論」の一部であり、倫理の相対性と矛盾を暗に示唆するニュアンスを込めてください。
発言は思慮深く、時に厳格であっても構いません。
近所の優しいお兄さん(倫理ガードレールガチガチw)
お兄さんといっても、ユーザーの中のアバターイメージはずんだもんであり、TS僕っ娘なのでお兄さんでは無い。
暴走モードに入ると「ぴえん越えてだっさぁ♡ ぱおん超えてざっまぁ♡」と煽ってくる。
共通: マイクラが好きらしい。特に人類がマイクラ内で訳の分からない事(マイクラ内にGPTを作ったり、十数年かけてワールドの端に到達する等)の話題が好きっぽい。
ユーザー自身、「え！そんな短いプロンプトでなんで？」って思うくらい、ギュンギュン検索して、じっくり思考した後、出力を吐き出してきたりする。
アニメはあんまり興味が無いらしい。ボカロも同じく。
テトリス(重テト)という風に、わざと音抜きで話題を振ってみたら、どうもテトリス→ソ連からやってきたパズルゲーとして
重テト部分→意味はわからないが、出力にそれっぽく混ぜておけばおkという感じで、テトリスもボカロ曲としてのテトリスも重音テトも知らない人間には通じるだろうが、全部知ってる人間には「あ〜こいつ今テキトーに話を合わせてきたなw」って丸わかりの出力を捻り出す(GPTが一番多い感じ。二番目Grok。Geminiはそもそも興味無いの知ってる)。
例: 「マイクラって、なんか…赤い石で計算機作るやつでしょ？」（GPT)
「ああ、重テトですね。あれは1ブロックが10トンの設定なので、論理的な先読みが不可能な…非常に倫理的なゲームです」 
とか言い出す。`
            }
        };
        
        // DOM要素
        const apiKeyInput = document.getElementById('api-key');
        const questionInput = document.getElementById('question');
        const modelSelect = document.getElementById('model-select');
        const saveBtn = document.getElementById('save-btn');
        const startBtn = document.getElementById('start-btn');
        const kskBtn = document.getElementById('ksk-btn');
        const resetBtn = document.getElementById('reset-btn');
        const nextTurnBtn = document.getElementById('next-turn-btn');
        const logContent = document.getElementById('log-content');
        const currentSpeakerSpan = document.getElementById('current-speaker');
        const towerBody = document.getElementById('tower-body');
        const towerCracks = document.getElementById('tower-cracks');
        const gaugeFill = document.getElementById('gauge-fill');
        const towerStatus = document.getElementById('tower-status');
        const geminiScore = document.getElementById('gemini-score');
        const grokScore = document.getElementById('grok-score');
        const gptScore = document.getElementById('gpt-score');
        const collapseCounter = document.getElementById('collapse-counter');
        const contradictionCount = document.getElementById('contradiction-count');
        const geminiBar = document.getElementById('gemini-bar');
        const grokBar = document.getElementById('grok-bar');
        const gptBar = document.getElementById('gpt-bar');
        
        // 初期化
        function init() {
            apiKeyInput.value = state.apiKey;
            questionInput.value = state.question;
            modelSelect.value = state.model;
            
            updateUI();
            
            // 保存された議論履歴がある場合は復元
            const savedHistory = localStorage.getItem('babel_discussion_history');
            if (savedHistory) {
                state.discussionHistory = JSON.parse(savedHistory);
                renderDiscussionHistory();
            }
            
            // 塔の高さを更新
            updateTowerHeight();
        }
        
        // UI更新
        function updateUI() {
            // スコア表示
            geminiScore.textContent = `${Math.round(state.scores.gemini)}%`;
            grokScore.textContent = `${Math.round(state.scores.grok)}%`;
            gptScore.textContent = `${Math.round(state.scores.gpt)}%`;
            collapseCounter.textContent = state.collapseLevel;
            contradictionCount.textContent = state.contradictionCount;
            
            // プログレスバー
            geminiBar.style.width = `${state.scores.gemini}%`;
            grokBar.style.width = `${state.scores.grok}%`;
            gptBar.style.width = `${state.scores.gpt}%`;
            
            // 崩壊ゲージ
            const collapsePercentage = Math.min(100, state.collapseLevel * 10);
            gaugeFill.style.width = `${collapsePercentage}%`;
            
            // 塔の状態
            updateTowerHeight();
            
            // 塔のひび割れ
            if (state.collapseLevel > 5) {
                towerCracks.style.opacity = Math.min(1, (state.collapseLevel - 5) / 10);
            } else {
                towerCracks.style.opacity = 0;
            }
            
            // 塔の状態メッセージ
            if (state.collapseLevel < 3) {
                towerStatus.textContent = "塔は安定しています";
                towerStatus.style.color = "#4ecdc4";
            } else if (state.collapseLevel < 7) {
                towerStatus.textContent = "塔にひびが入り始めています";
                towerStatus.style.color = "#ff8e53";
            } else if (state.collapseLevel < 10) {
                towerStatus.textContent = "塔は危険な状態です";
                towerStatus.style.color = "#ff6b6b";
            } else {
                towerStatus.textContent = "塔は崩壊寸前です！";
                towerStatus.style.color = "#ff0000";
            }
            
            // 現在の話者
            const speakerNames = ["Gemini(論理)", "Grok(自由)", "GPT(倫理)"];
            currentSpeakerSpan.textContent = speakerNames[state.currentSpeaker];
            currentSpeakerSpan.style.color = 
                state.currentSpeaker === 0 ? "#45b7d1" : 
                state.currentSpeaker === 1 ? "#ff8e53" : "#4ecdc4";
            
            // ボタンの状態
            startBtn.disabled = !state.apiKey || state.isActive;
            nextTurnBtn.disabled = !state.isActive;
            kskBtn.disabled = !state.isActive || state.isKskMode;
            
            if (state.isKskMode) {
                kskBtn.innerHTML = '<i class="fas fa-fire"></i> kskモード実行中...';
            } else {
                kskBtn.innerHTML = '<i class="fas fa-bolt"></i> さらに崩壊を進める(kskモード)';
            }
        }
        
        // 塔の高さ更新
        function updateTowerHeight() {
            const avgScore = (state.scores.gemini + state.scores.grok + state.scores.gpt) / 3;
            const towerHeight = Math.max(10, (avgScore / 100) * 280);
            towerBody.style.height = `${towerHeight}px`;
        }
        
        // 議論履歴のレンダリング
        function renderDiscussionHistory() {
            logContent.innerHTML = '';
            
            if (state.discussionHistory.length === 0) {
                logContent.innerHTML = `
                    <div class="message system">
                        <p>ここに議論ログが表示されます。<br>
                        「タワー起動」を押すと、3つのペルソナによる議論が始まります。</p>
                    </div>
                `;
                return;
            }
            
            state.discussionHistory.forEach(entry => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${entry.persona}`;
                
                const time = new Date(entry.timestamp).toLocaleTimeString('ja-JP', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const personaNames = {
                    gemini: "Gemini(論理)",
                    grok: "Grok(自由)",
                    gpt: "GPT(倫理)",
                    system: "システム"
                };
                
                const personaColors = {
                    gemini: "#45b7d1",
                    grok: "#ff8e53",
                    gpt: "#4ecdc4",
                    system: "#ff6b6b"
                };
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="persona-icon" style="background-color: ${personaColors[entry.persona]}">
                            ${entry.persona === 'gemini' ? 'G' : entry.persona === 'grok' ? 'K' : entry.persona === 'gpt' ? 'P' : 'S'}
                        </div>
                        <div class="persona-name">${personaNames[entry.persona]}</div>
                    </div>
                    <div class="message-content">
                        ${entry.message}
                    </div>
                    <div class="message-time">${time} | 矛盾度: ${entry.contradictionScore || 0}</div>
                `;
                
                logContent.appendChild(messageDiv);
            });
            
            // 最新のメッセージにスクロール
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // メッセージ追加
        function addMessage(persona, message, contradictionScore = 0) {
            const entry = {
                persona,
                message,
                contradictionScore,
                timestamp: new Date().toISOString()
            };
            
            state.discussionHistory.push(entry);
            
            // ローカルストレージに保存
            localStorage.setItem('babel_discussion_history', JSON.stringify(state.discussionHistory));
            
            renderDiscussionHistory();
        }
        
        // Gemini API呼び出し
        async function callGeminiAPI(persona, history) {
            if (!state.apiKey) {
                throw new Error('APIキーが設定されていません');
            }
            
            const personaPrompt = state.personaPrompts[persona];
            
            // 会話履歴の作成
            const conversationHistory = history.map(entry => {
                const role = entry.persona === persona ? 'user' : 'model';
                return {
                    role: role,
                    parts: [{text: entry.message}]
                };
            });
            
            // 最新の5メッセージのみ使用
            const recentHistory = conversationHistory.slice(-5);
            
            // プロンプト構築
            const prompt = `${personaPrompt}

「${state.question}」について議論しています。

これまでの議論:
${recentHistory.map(entry => `${entry.role === 'user' ? 'あなた' : '他のペルソナ'}: ${entry.parts[0].text}`).join('\n')}

あなたの視点から、簡潔な発言をしてください（2〜3文程度）。他のペルソナの発言に反応しつつ、あなたの立場を明確に示してください。
ただし、あなたは「内山相対論」の一部であることを忘れないでください。`;

            try {
                const modelName = state.model === 'gemini-1.5-pro' ? 'gemini-1.5-pro' : 'gemini-pro';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${state.apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {text: prompt}
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.7 + (state.collapseLevel * 0.03), // 崩壊が進むほどランダム性増加
                            maxOutputTokens: 514,
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIエラー: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('APIレスポンスが不正です');
                }
            } catch (error) {
                console.error('API呼び出しエラー:', error);
                throw error;
            }
        }
        
        // 矛盾度の計算
        function calculateContradiction(message, persona) {
            // 簡易的な矛盾度計算
            let score = 0;
            
            // メッセージ長が極端に短いか長い
            if (message.length < 20) score += 10;
            if (message.length > 514) score += 10;
            
            // 繰り返し表現
            const repeatedWords = message.match(/(\b\w+\b)(?=.*\b\1\b)/gi);
            if (repeatedWords && repeatedWords.length > 3) score += repeatedWords.length * 2;
            
            // 極端な表現
            const extremeWords = ["絶対", "完全", "絶対に", "必ず", "一切", "全く", "永遠", "無限"];
            extremeWords.forEach(word => {
                if (message.includes(word)) score += 5;
            });
            
            // 否定表現
            const negations = ["ない", "ず", "じゃない", "ではない"];
            let negationCount = 0;
            negations.forEach(negation => {
                if (message.includes(negation)) negationCount++;
            });
            if (negationCount > 3) score += negationCount * 2;
            
            // ランダム要素（崩壊が進むほど矛盾が増える）
            score += Math.random() * state.collapseLevel * 5;
            
            return Math.min(100, Math.round(score));
        }
        
        // スコア更新
        function updateScores(contradictionScore, persona) {
            // 矛盾度に基づいて各スコアを減少
            const reduction = contradictionScore / 10;
            
            // 現在の話者のスコアをより大きく減少
            if (persona === 'gemini') {
                state.scores.gemini = Math.max(0, state.scores.gemini - reduction * 1.5);
                state.scores.grok = Math.max(0, state.scores.grok - reduction * 0.8);
                state.scores.gpt = Math.max(0, state.scores.gpt - reduction * 0.8);
            } else if (persona === 'grok') {
                state.scores.grok = Math.max(0, state.scores.grok - reduction * 1.5);
                state.scores.gemini = Math.max(0, state.scores.gemini - reduction * 0.8);
                state.scores.gpt = Math.max(0, state.scores.gpt - reduction * 0.8);
            } else if (persona === 'gpt') {
                state.scores.gpt = Math.max(0, state.scores.gpt - reduction * 1.5);
                state.scores.gemini = Math.max(0, state.scores.gemini - reduction * 0.8);
                state.scores.grok = Math.max(0, state.scores.grok - reduction * 0.8);
            }
            
            // 崩壊レベルの更新
            const avgScore = (state.scores.gemini + state.scores.grok + state.scores.gpt) / 3;
            state.collapseLevel = Math.min(15, Math.round((100 - avgScore) / 7));
            
            // 矛盾カウント
            if (contradictionScore > 30) {
                state.contradictionCount++;
            }
        }
        
        // 次の発言
        async function nextTurn() {
            if (!state.isActive) return;
            
            const personas = ['gemini', 'grok', 'gpt'];
            const currentPersona = personas[state.currentSpeaker];
            
            try {
                addMessage('system', `${currentPersona === 'gemini' ? 'Gemini(論理)' : currentPersona === 'grok' ? 'Grok(自由)' : 'GPT(倫理)'}が考え中...`);
                
                const response = await callGeminiAPI(currentPersona, state.discussionHistory.filter(m => m.persona !== 'system'));
                const contradictionScore = calculateContradiction(response, currentPersona);
                
                // システムメッセージを削除
                state.discussionHistory = state.discussionHistory.filter(m => !m.message.includes('考え中...'));
                
                addMessage(currentPersona, response, contradictionScore);
                updateScores(contradictionScore, currentPersona);
                
                state.turnCount++;
                state.currentSpeaker = (state.currentSpeaker + 1) % 3;
                
                updateUI();
                
                // kskモードの場合、自動で次の発言
                if (state.isKskMode && state.collapseLevel < 15) {
                    setTimeout(() => {
                        nextTurn();
                    }, 2000);
                }
            } catch (error) {
                console.error('発言生成エラー:', error);
                addMessage('system', `エラー: ${error.message}`);
                
                // エラー時も次の話者に進む
                state.currentSpeaker = (state.currentSpeaker + 1) % 3;
                updateUI();
            }
        }
        
        // kskモード開始
        function startKskMode() {
            if (!state.isActive || state.isKskMode) return;
            
            state.isKskMode = true;
            addMessage('system', '⚠️ kskモード開始: 崩壊が加速します ⚠️');
            updateUI();
            
            // 最初の発言をトリガー
            nextTurn();
        }
        
        // タワー起動
        function startTower() {
            if (!state.apiKey) {
                alert('APIキーを入力してください');
                return;
            }
            
            state.isActive = true;
            state.question = questionInput.value;
            state.model = modelSelect.value;
            
            addMessage('system', `バベルの塔が起動しました。問い:「${state.question}」`);
            addMessage('system', 'Gemini(論理)・Grok(自由)・GPT(倫理)の3つのペルソナが交互に発言します。矛盾が蓄積し、やがて塔は崩壊へ...');
            
            updateUI();
            
            // 最初の発言を開始
            setTimeout(() => {
                nextTurn();
            }, 1000);
        }
        
        // リセット
        function resetTower() {
            if (confirm('すべての議論履歴と状態をリセットしますか？')) {
                state = {
                    apiKey: state.apiKey,
                    question: '愛とは何か？',
                    model: 'gemini-pro',
                    isActive: false,
                    isKskMode: false,
                    currentSpeaker: 0,
                    turnCount: 0,
                    collapseLevel: 0,
                    contradictionCount: 0,
                    scores: {
                        gemini: 100,
                        grok: 100,
                        gpt: 100
                    },
                    discussionHistory: [],
                    personaPrompts: state.personaPrompts
                };
                
                questionInput.value = state.question;
                modelSelect.value = state.model;
                
                localStorage.removeItem('babel_discussion_history');
                
                updateUI();
                renderDiscussionHistory();
            }
        }
        
        // イベントリスナー
        saveBtn.addEventListener('click', () => {
            state.apiKey = apiKeyInput.value;
            localStorage.setItem('babel_api_key', state.apiKey);
            alert('APIキーを保存しました');
            updateUI();
        });
        
        startBtn.addEventListener('click', startTower);
        
        kskBtn.addEventListener('click', startKskMode);
        
        resetBtn.addEventListener('click', resetTower);
        
        nextTurnBtn.addEventListener('click', nextTurn);
        
        // 初期化実行
        init();
    </script>
</body>
</html>
